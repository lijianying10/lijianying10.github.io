<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>philo.top</title>
        <link href="/css/prism.css" rel="stylesheet">
        <link href="/css/bootstrap.min.css" rel="stylesheet">
        <link href="/css/blog-post.css" rel="stylesheet">
        <link href="/css/typo.css" rel="stylesheet">
        <link rel="shortcut icon" href="/favicon.ico" />
    </head>

    <body>

        <!-- Navigation -->
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">Philo</a>
                </div>
                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li>
                            <a href="/">HOME</a>
                        </li>
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        <li>
                            <a href="/2015/02/21/index/index.html">About</a>
                        </li>
                    </ul>
                </div>
                <!-- /.navbar-collapse -->
            </div>
            <!-- /.container -->
        </nav>

        <!-- Page Content -->
        <div class="container" style="
                margin-top: 70px;
                ">

            <div class="row">

                <!-- Blog Post Content Column -->
                <div class="col-lg-9 col-12">

                    <!-- Blog Post -->

<!-- Title -->
<h1><a href="/2021/03/14/metaprogramming/">Metaprogramming and code generation/replace in action</a></h1>
 
<!-- Author -->
<p class="lead">
Tags

<a href="/tags/metaprogramming">metaprogramming</a>

</p>

<hr>

<!-- Date/Time -->
<p><span class="glyphicon glyphicon-time"></span> 2021-03-14 22:01:54</p>

<hr>

<div class="typo">
<h2>What is Metaprogramming</h2>

<p>Metaprogramming, for short, is a program that can treat other programs as data. It can be designed to read, generate, analyze or transform other programs. <a href="https://en.wikipedia.org/wiki/Metaprogramming">Detail</a></p>

<p>In this article, we concentrate on static code not in the process running phase.</p>

<h2>Macro</h2>

<p>Macro means how a code block should be mapped to a replacement output. <a href="https://en.wikipedia.org/wiki/Macro_(computer_science)">Detail</a>. Macro is a commonly used tool for the implementation of MetaProgramming.</p>

<h3>Macro in C</h3>

<p>Suppose you are new to the C language. You may don&rsquo;t know you are already use Metaprogramming in action. Such as the following example:</p>

<p>some examples:</p>

<p>e.g 1:</p>

<pre><code>#include &lt;stdio.h&gt;
int main() {
   printf(&quot;Hello, World!&quot;);
   return 0;
}
</code></pre>

<p>Here we got <code>#include</code> is a macro to import function definition from the header file.</p>

<p>e.g 2:</p>

<pre><code>#define PI 3.14159
</code></pre>

<p>This code fragment will cause the string &ldquo;PI&rdquo; to be replaced with &ldquo;3.14159&rdquo;, we call it parameterized macro.</p>

<p>e.g 3:</p>

<pre><code>#if WIN32
	#include	&lt;winsock.h&gt;
#elif LINUX
	#include	&lt;sys/socket.h&gt;
#endif
</code></pre>

<p>A macro could read variables. Different target platforms use specific herder files.</p>

<p>e.g 4:</p>

<pre><code>#define pred(x)  ((x)-1)
</code></pre>

<p>We can easily take advantage of the <code>inline function</code> definition through the definition of a Macro. We don&rsquo;t care about the type of x cause the code needs to expand before compile. Moreover, define Macro as a function without any type definition. It can provide you lots of flexibility to make your project more clean and readable.</p>

<p>the C language toolchain compiles your source code through the following workflow in detail:</p>

<p><img src="https://user-images.githubusercontent.com/3077762/111071428-1d73d200-8511-11eb-9abd-23d41a801d61.png" alt="" /></p>

<h3>summary</h3>

<p>As the previous example showing that Metaprogramming is not a strange thing. We often use it in daily programming.</p>

<h2>Code replace in action</h2>

<h3>AST parser</h3>

<p>For actually and safety code replace, we need to study two new concepts: <code>AST</code> and <code>AST parser</code>.</p>

<p>AST is the abbreviation of Abstract Syntax Tree, a kind of tree data structure. Each node of the tree denotes a construct occurring in the source code.
<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Detail</a></p>

<p>AST parser is a library or package for parsing a source code file or fragment to a tree data structure tool. Programming language specification too complex to replace by simple string replacement. It can not cover most usage cases. We use the <code>AST parser</code> tool to search or operation a tree structure to meet the requirements.</p>

<p>example parser for jsx</p>

<pre><code class="language-javascript">babelParser = require('@babel/parser');
const res = babelParser.parse(`
ReactDOM.render(
  &lt;h1&gt;Hello, world!&lt;/h1&gt;,
  document.getElementById('root')
);`,{plugins:[ 'jsx', 'flow' ]});
console.log(JSON.stringify(res));
</code></pre>

<p>Then we got a very large JSON to tell us every detail of this code. <a href="https://pastebin.com/AAch75nV">pastebin: detail</a></p>

<pre><code class="language-json">{
  &quot;type&quot;: &quot;CallExpression&quot;,
  &quot;start&quot;: 1,
  &quot;end&quot;: 79,
  &quot;loc&quot;: {
    &quot;start&quot;: {
      &quot;line&quot;: 2,
      &quot;column&quot;: 0
    },
    &quot;end&quot;: {
      &quot;line&quot;: 5,
      &quot;column&quot;: 1
    }
  },
  &quot;callee&quot;: {
    &quot;blah&quot;:&quot;blah&quot;
  }
}
</code></pre>

<p>Here&rsquo;s part of the result. As an example, we can get the information that the expression is call function expression and get the code&rsquo;s position.
Even the location line and column information and tell us every <code>callee</code> (every member of function call parameter)</p>

<p>The parser is a part of the language compiler (or part of the compiler frontend).
The parser is often used as an infrastructure for code static analysis and code automation complete in an editor.</p>

<p>More example:</p>

<ol>
<li>Markdown-parser <a href="https://www.npmjs.com/package/markdown-parser">https://www.npmjs.com/package/markdown-parser</a></li>
<li>yaml-parser <a href="https://www.npmjs.com/package/js-yaml">https://www.npmjs.com/package/js-yaml</a></li>
</ol>

<h3>code scanning for ci</h3>

<p>After parsing the source code to the syntax tree, we can write a deep search first algorithm for specific coding behavior.
Then deploy the algorithm to CI workflow before compile source code.</p>

<p>Here&rsquo;s an example for checkout whether any code behavior returns an error but doesn&rsquo;t return the None 200 status code.
The function implementation based on if we check error is not <code>nil</code> there must call some function <code>w.Writeheader(xxx)</code>, and the parameter may not be 2xx</p>

<p>We got this requirement from the middleware team, who develop a web load balance and monitor the website&rsquo;s error status.</p>

<p>For shorter and straightforward we made a small example only check a function is HTTP handler:</p>

<pre><code class="language-golang">package main

import (
	&quot;fmt&quot;
	&quot;go/ast&quot;
	&quot;go/parser&quot;
	&quot;go/token&quot;
)

func main() {
	// src is the input for which we want to print the AST.
	src := `
package main
func (rt *Runtime) FileReceive(w http.ResponseWriter, r *http.Request) {
}
`

	// Create the AST by parsing src.
	fset := token.NewFileSet() // positions are relative to fset
	f, err := parser.ParseFile(fset, &quot;&quot;, src, 0)
	if err != nil {
		panic(err)
	}

  // Print the AST.
  ast.Print(fset, f)

	ast.Inspect(f, func(n ast.Node) bool { // deep first node visitor
		switch x := n.(type) {
		case *ast.FuncType: // check node is a function
			if len(x.Params.List) != 2 { // check function parameter length
				return false
			}
			p1, p2 := false, false
			if val, ok := x.Params.List[0].Type.(*ast.SelectorExpr); ok { // check parameter type is http.ResponseWriter
				if valExpr, ok := val.X.(*ast.Ident); ok {
					if valExpr.Name == &quot;http&quot; &amp;&amp; val.Sel.Name == &quot;ResponseWriter&quot; {
						p1 = true
					}
				}
			}
			if val, ok := x.Params.List[1].Type.(*ast.StarExpr); ok { // check parameter type is *http.Request
				if starX, ok := val.X.(*ast.SelectorExpr); ok {
					if starXX, ok := starX.X.(*ast.Ident); ok {
						if starXX.Name == &quot;http&quot; &amp;&amp; starX.Sel.Name == &quot;Request&quot; {
							p2 = true
						}
					}
				}
			}
			if p1 &amp;&amp; p2 {
				fmt.Println(&quot;handler found&quot;)
			}
		}
		return true
	})
}
</code></pre>

<p>Tips: type assertation following the printed AST node tree.</p>

<h3>example of replacing code</h3>

<p>Follow the path got safe and accurately replace code result:</p>

<ol>
<li>reuse previously mentioned search algorithm methodology</li>
<li>direct operation to the syntax tree</li>
<li>compile the syntax tree to source code</li>
<li>format code makes it looks pretty cool.</li>
</ol>

<p>Use case: When you got a GO project to upgrade the original log module (fmt.Println) to a newly designed log module (log.Log())</p>

<p>and example code for golang (by golang.org/x/tools/go/ast/astutil) <a href="https://play.golang.org/p/jDSpmV_Kxnt">https://play.golang.org/p/jDSpmV_Kxnt</a></p>

<h3>example of code gen</h3>

<p>For the example of code generation, we have already have lots of widely used tools:</p>

<h4>protobuf</h4>

<p>GRPC is a common tool for <a href="https://en.wikipedia.org/wiki/Remote_procedure_call">RPC</a>. The message encoding uses the standard named protobuf.</p>

<p>here is an example for code generation use following protobuf file example fill the left blank: <a href="https://protogen.marcgravell.com/">https://protogen.marcgravell.com/</a></p>

<p>example protobuf file:</p>

<pre><code class="language-protobuf">syntax = &quot;proto3&quot;;

message ExampleMessage {
    int32 foo = 1;
    string bar = 3;
}
</code></pre>

<h4>sqlc</h4>

<p>To fully control the SQL query and performance, we don&rsquo;t use ORM but code generation.
This code generation tool can help us a lot for those repeat work on translate SQL results to the local data structure.</p>

<p>Example convert SQL file to golang DAO layer: <a href="https://play.sqlc.dev/">https://play.sqlc.dev/</a></p>

<h2>In summary</h2>

<p>Metaprogramming is a commonly used method for programming. It can reduce repeat work and improve engineering quality.</p>

<p>Learning, sharing, and improve together.</p>

</div>

<hr>
本人博客文章采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC Attribution-NonCommercial协议</a>: CC Attribution-NonCommercial 必须保留原作者署名,并且不允许用于商业用途,其他行为都是允许的。
<hr>

<script src="https://utteranc.es/client.js"
        repo="lijianying10/RollingBlog"
        issue-term="Metaprogramming and code generation/replace in action"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<!-- Blog Post -->

<!-- Title -->
<h1><a href="/2021/02/15/dockerprivateregistryen/">deploy docker registry under private network</a></h1>
 
<!-- Author -->
<p class="lead">
Tags

<a href="/tags/docker">docker</a>

<a href="/tags/registry">registry</a>

<a href="/tags/ssl">ssl</a>

<a href="/tags/nginx">nginx</a>

</p>

<hr>

<!-- Date/Time -->
<p><span class="glyphicon glyphicon-time"></span> 2021-02-15 15:30:35</p>

<hr>

<div class="typo">
<p>Docker registry is an essential infrastructure of docker daemon or Kubernetes. We package project artifacts by docker image while storage and distribution by registry service. Today we will show you how we are setting up a straightforward and small registry implementation by docker official. It convenience a docking workflow for CI/CD.</p>

<p>Deploy structure:</p>

<p><img src="https://user-images.githubusercontent.com/3077762/107914469-76e1f300-6f9d-11eb-8b78-aaf7dad4c258.png" alt="image" /></p>

<h2>Deploy services</h2>

<h3>Container</h3>

<pre><code class="language-bash">docker run -d -p 5000:5000 --restart=always --name registry -v /data/registry:/var/lib/registry registry:2
docker run -d -p 5001:80 --name registry-ui -e DELETE_IMAGES=true joxit/docker-registry-ui:static
</code></pre>

<ol>
<li>Replace path <code>/data/registry</code> to your own storage path</li>
<li><code>-e DELETE_IMAGES=true</code> intends docker images can delete through UI operation

<ol>
<li>Reference document by link <a href="https://hub.docker.com/r/joxit/docker-registry-ui">https://hub.docker.com/r/joxit/docker-registry-ui</a></li>
<li>In paragraph <code>Run the static interface</code></li>
</ol></li>
<li>Code review image <code>joxit/docker-registry-ui:static</code> docker file we can know:

<ol>
<li>The HTTP service is just an nginx process with a bunch of static HTTP static files.</li>
<li>The <code>cross region</code> and <code>registry_url</code> and <code>SSL</code> config can be moved to our nginx deploy for more flexible and clean config management.</li>
</ol></li>
</ol>

<h3>Host nginx deploy</h3>

<p>Generally, we install nginx by Linux package management such as apt.</p>

<p>We can install nginx under ubuntu by the command <code>sudo apt-get update &amp;&amp; sudo apt-get install -y nginx</code></p>

<p>Then we install the following config file under your config dir. The default path is <code>/etc/nginx/sites-enabled/</code></p>

<p>Here we storage the config file in <code>/etc/nginx/sites-enabled/registry</code></p>

<pre><code>server {
    listen 443 ssl;
    server_name [[REPLACE: YOUR OWN DOMAIN NAME]];
    ssl_certificate     /etc/ssl/[[REPLACE: YOUR DOMAIN SSL CRT FILE]];
    ssl_certificate_key /etc/ssl/[[REPLACE: YOUR DOMAIN SSL KEY FILE]];
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    client_max_body_size 2048M;
    location / {
        proxy_pass http://127.0.0.1:5001;
    }
    location /v2 {
        proxy_pass http://127.0.0.1:5000;
    }
}

server{
    listen 80;
    server_name [[REPLACE: YOUR OWN DOMAIN NAME]];
    return 301 https://$host$request_uri;
}
</code></pre>

<p><code>ATTENTION:</code> please replace the config with your environment situation.</p>

<ol>
<li>The parameter <code>server_name</code> must replace with your domain name.</li>
<li>We recommend using <code>Let’s encrypt</code> DNS-01 challenge to verify your domain and get an SSL cert file.</li>
<li>The parameter <code>ssl_certificate</code> must replace with your domain crt file.</li>
<li>The parameter <code>ssl_certificate_key</code> must replace with your domain key file.</li>
<li>The parameter <code>client_max_body_size</code> at 2GB since we usually push a large docker image layer in practice.</li>
<li><code>location /</code> route to registry UI container.</li>
<li><code>location /v2</code> route to registry service.</li>
<li>Don&rsquo;t forget to set A record for your domain.</li>
<li>We highly recommend setting up nginx <code>HTTPS</code> for your service since the docker daemon or kubelet needs other configs to trust your registry.</li>
<li>The second <code>server</code> under the config file which helps us force switch from <code>HTTP</code> to <code>HTTPS</code></li>
</ol>

<p><code>SAFETY WARNING:</code></p>

<ol>
<li><code>Do not</code> deploy this solution in the public network.</li>
<li>Use it in a small team under a private network.</li>
</ol>

</div>

<hr>
本人博客文章采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC Attribution-NonCommercial协议</a>: CC Attribution-NonCommercial 必须保留原作者署名,并且不允许用于商业用途,其他行为都是允许的。
<hr>

<script src="https://utteranc.es/client.js"
        repo="lijianying10/RollingBlog"
        issue-term="deploy docker registry under private network"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<!-- Blog Post -->

<!-- Title -->
<h1><a href="/2021/02/14/golangvimdev/">my vim golang programming environment</a></h1>
 
<!-- Author -->
<p class="lead">
Tags

<a href="/tags/golang">golang</a>

<a href="/tags/vim">vim</a>

<a href="/tags/docker">docker</a>

</p>

<hr>

<!-- Date/Time -->
<p><span class="glyphicon glyphicon-time"></span> 2021-02-14 23:35:19</p>

<hr>

<div class="typo">
<p>If you are also suffered from vim emulation or facked vim such as ideavim or vscodevim. Today we will show you a new golang development environment under docker or use it out of the box. And easy to tweak by our public dockerfile and built image from docker hub public image. Here&rsquo;s a list of features in the following article.</p>

<h2>features</h2>

<p>Autocomplete by language server without import package we need. While showing function parameters and documents.</p>

<p><img src="https://user-images.githubusercontent.com/3077762/107909035-53657b00-6f92-11eb-8b09-49741eb77d18.png" alt="image" /></p>

<p>We use onedark color theme as the basic vim color solution. Here we give two everyday operations examples as below.</p>

<ol>
<li>Rename variable</li>
<li>Add tags to struct</li>
</ol>

<p><a href="https://asciinema.org/a/qX4GNuz8InY1aqPLRwGMrVRt0"><img src="https://asciinema.org/a/qX4GNuz8InY1aqPLRwGMrVRt0.svg" alt="asciicast" /></a></p>

<p>The example below use <a href="https://github.com/etcd-io/etcd">ETCD</a> as demo project show the following feature:</p>

<ol>
<li>tini for container init process</li>
<li>auto complete</li>
<li>go to definition</li>
<li>FZF search file</li>
</ol>

<p><a href="https://asciinema.org/a/egDeADL1ITctljs1C9pFjqghG"><img src="https://asciinema.org/a/egDeADL1ITctljs1C9pFjqghG.svg" alt="asciicast" /></a></p>

<p>Of course gopls (which is a golang toolchain we depend on) use over 40 seconds to scan so large project. But gopls also have a cache feature accelerate open project in the next time.</p>

<h2>how to use it</h2>

<p>pull the docker image by command:</p>

<pre><code>docker pull lijianying10/golangdev:21Feb7-01
</code></pre>

<p>docker run by following command</p>

<pre><code>docker run -it --rm -v $PWD/etcd:/root/etcd lijianying10/golangdev:21Feb7-01 /bin/bash
</code></pre>

<p>Attention: alter the dir mapping to your project path, and we highly recommend using <code>gomod</code> as the project manager.</p>

<h2>Dockerfile</h2>

<p>ref link: <a href="https://github.com/lijianying10/FixLinux/blob/master/golangdev/Dockerfile">https://github.com/lijianying10/FixLinux/blob/master/golangdev/Dockerfile</a></p>

<h2>vim dot file</h2>

<p>ref link: <a href="https://github.com/lijianying10/FixLinux/blob/master/dotfile/.vimrc">https://github.com/lijianying10/FixLinux/blob/master/dotfile/.vimrc</a></p>

<h3>shortcut keys (key maps)</h3>

<p>start from <a href="https://github.com/lijianying10/FixLinux/blob/master/dotfile/.vimrc#L97">LOC 79</a> of dot file.</p>

<pre><code class="language-viml">nmap &lt;M-p&gt; :TagbarToggle&lt;CR&gt; &quot; view tag bar
imap &lt;M-p&gt; &lt;esc&gt;:TagbarToggle&lt;CR&gt;i
nmap &lt;M-u&gt; :NERDTreeToggle&lt;CR&gt; &quot; view file list
imap &lt;M-u&gt; &lt;esc&gt;:NERDTreeToggle&lt;CR&gt;
nmap &lt;C-c&gt; :q&lt;CR&gt; &quot; exit 
nmap &lt;M-o&gt; :tabn&lt;CR&gt; &quot; tab next
imap &lt;M-o&gt; &lt;esc&gt;:tabn&lt;CR&gt;
nmap &lt;M-i&gt; :tabp&lt;CR&gt; &quot; tab previous
imap &lt;M-i&gt; &lt;esc&gt;:tabp&lt;CR&gt;
nmap &lt;M-l&gt; :w&lt;CR&gt;:GoMetaLinter&lt;CR&gt; &quot; linter 
nmap &lt;M-n&gt; &lt;Plug&gt;(coc-definition) &quot; go to definition
nmap &lt;C-z&gt; :undo&lt;CR&gt; &quot; undo
nmap &lt;M-y&gt; :GoErrCheck&lt;CR&gt; &quot; go error check
nmap &lt;C-s&gt; :w&lt;CR&gt; &quot; save
imap &lt;C-s&gt; &lt;esc&gt;:w&lt;CR&gt;
imap &lt;M-c&gt; &lt;esc&gt;:pc&lt;CR&gt;
nmap &lt;M-c&gt; :pc&lt;CR&gt; &quot; close preview window
nmap &lt;leader&gt;r :Ack&lt;space&gt; &quot; search hole project document: https://github.com/mileszs/ack.vim
nmap &lt;leader&gt;t :FZF&lt;CR&gt; &quot; zfz file search
</code></pre>

<p>example key mapping:</p>

<ol>
<li>M-p means <code>Meta + p</code> Option key for mac and alt key for windows keyboard</li>
<li>C-s means <code>Ctrl + s</code></li>
<li><code>&lt;leader&gt;t</code> means press <code>\</code> and then press t</li>
</ol>

</div>

<hr>
本人博客文章采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC Attribution-NonCommercial协议</a>: CC Attribution-NonCommercial 必须保留原作者署名,并且不允许用于商业用途,其他行为都是允许的。
<hr>

<script src="https://utteranc.es/client.js"
        repo="lijianying10/RollingBlog"
        issue-term="my vim golang programming environment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<!-- Blog Post -->

<!-- Title -->
<h1><a href="/2021/02/06/bazelmacro/">bazel macro 的开发</a></h1>
 
<!-- Author -->
<p class="lead">
Tags

<a href="/tags/bazel">bazel</a>

</p>

<hr>

<!-- Date/Time -->
<p><span class="glyphicon glyphicon-time"></span> 2021-02-06 13:17:41</p>

<hr>

<div class="typo">
<p>当你有了很多rules可以用在你的工程，当你做一些事务去构建你的目标你会发现BUILDfile开始出现大段的只有参数不同的重复代码降低了代码的复用率。</p>

<p>bazel 的不同于其他构建过程的配置并不是创造一个DSL出来解决这个问题。而通过 Starlark 语言来做到 target 分析。 其关键点在于bazel的运行分为三个阶段 (<a href="https://docs.bazel.build/versions/master/skylark/concepts.html#evaluation-model">three phase</a>) 其中我们使用 starlark 语言去定义我们的构建目标的过程是在第二个阶段。</p>

<h2>一个Macro的例子</h2>

<pre><code class="language-starlark">load(&quot;:render.bzl&quot;, &quot;blender_render&quot;)
load(&quot;//ffmpeg:ffmpeg.bzl&quot;, &quot;ffmpeg_combine_video&quot;)

def blender_render_batch(targets, out):
    render_targets = []
    for t in targets:
        lb = Label(t)
        render_targets.append(t+&quot;_render&quot;)
        blender_render(
            name = lb.name+&quot;_render&quot;,
            blender_project = t,
            out = lb.name+&quot;.mp4&quot;
        )
    ffmpeg_combine_video(
        name = out+&quot;_render&quot;,
        input = render_targets,
        out = out+&quot;.mp4&quot;,
    )
</code></pre>

<p>CodeReview提示：进入函数之后我们通过 <code>blender_render</code> 这个 <code>rule</code> 把数组内标记的 <code>blender project</code> 渲染成 <code>mp4</code> 视频文件并且记录相关的渲染过程的 <code>target</code> 到数组 <code>render_targets</code> 中最后放到 <code>ffmpeg_combine_video</code> 这个 <code>rule</code> 把这一系列的mp4文件合并成为一个整体视频。这样我们就可以通过这个方法实现视频的工业化生产减少人工剪辑的介入。</p>

<p>让我们来观察上面的macro实现</p>

<ol>
<li>我们需要把上面的代码放到 <code>render_batch.bzl</code> 中。

<ol>
<li>然后我们可以通过 <code>load(&quot;@rules_3dmodule//blender:render_batch.bzl&quot;,&quot;blender_render_batch&quot;)</code> 如上的load代码就可以准备好调用上面的函数实现了。</li>
</ol></li>
<li>我们可以看到其实还是与写 <code>rule</code> 很像，只是我们并不需要定义 <code>rule</code> 函数中也不需要有 <code>ctx</code> 更不需要 <code>actions</code> 有所执行。</li>
<li>其中核心的功能实现是通过 <code>load</code> rule 之后把 rule 当成函数调用即可。</li>
<li>在写 <code>starlark</code> 代码中需要注意只有数组(<code>array</code>)和字典(<code>dict</code>)是可以修改(<code>mutable</code>)的变量其他的都是不可修改(<code>immutable</code>)变量这是为了并行, 这在代码开发中至关重要。按照普通开发语言的开发思路去写会因此掉到坑里。</li>
</ol>

<h2>深入解析</h2>

<p>通过上面的例子我们可以通过分析了解到： <code>Analysis phase</code> 从原理上来讲是通过 <code>(ctx.action)[https://docs.bazel.build/versions/master/skylark/lib/actions.html]</code> 作为 <code>(DAG)[https://en.wikipedia.org/wiki/Directed_acyclic_graph]</code> 的 <code>Node</code> 我们可以从<a href="https://docs.bazel.build/versions/master/build-ref.html#dependencies">这里</a> 来印证我们的观察。 因此我们写的代码或者准确来说 <code>Macro</code> 是通过运行之后帮助 <code>bazel</code> 来构建整个 <code>DAG</code> 的过程。 掌握了这个核心思想之后再开发 <code>Macro</code> 会轻松很多。</p>

<h2>状态处理</h2>

<p>当我们学会了把一些列固定的操作写到函数当中很快你会发现你需要对状态进行处理。 例如在我的工程中，我需要对每个 blender target 标记需要并且让构建运行时知道自己在整体工程中的位置，从视频剪辑的角度来讲叫做场序（或者说你是第几个视频片段）因此我们写的Macro需要处理运行状态问题。</p>

<p>一个例子：</p>

<p>以下为文件 <code>counter.bzl</code> 的内容</p>

<pre><code>def video_scene_append(target_list,target):
    c = len(target_list)
    target_list.append(&quot;//%s:%s&quot;%(native.package_name(),target))
    return c
</code></pre>

<p>文件说明： 我们把target变量append到target_list当中，并且返回target在数组中的index作为函数返回。 这样我们就可以定义出target在构建中的序号了。</p>

<p>以下为 BUILD 的文件内容</p>

<pre><code>load(&quot;counter.bzl&quot;,&quot;video_scene_append&quot;)

# 1. storage video sequence list
# 2. as a counter for video move sequence
video_scene_list = []

video_scene_append(video_scene_list,&quot;stag1&quot;)
</code></pre>

<p>我们把状态存储的变量放到 <code>BUILD</code> 文件当中， 并且调用函数实现功能。</p>

<h2>配置处理建议</h2>

<p>我们可以使用 Jsonnet 来作为配置生成的入口下面是一个例子：</p>

<p>在 <code>BUILD</code> file 当中</p>

<pre><code>jsonnet_to_json(
    name = &quot;config_gen_stag4&quot;, 
    src = &quot;databargroup_config.jsonnet&quot;, 
    outs = [&quot;config_gen_stag4.json&quot;], 
    ext_code = {
        &quot;config&quot;: &quot;&quot;&quot;
        {
            default_shift_between_bar:2.6,
            animation_config+:{
                data_bar_keep_frames:24*2,
            },
            num_panel_cfg+:{
                data_division:1.0
            }
        }
        &quot;&quot;&quot;,
        &quot;data_bar_count&quot;:str(first_video_consts_get(stag4_dbg_count_key_name)),
    }, 
)
</code></pre>

<p>在 <code>databargroup_config.jsonnet</code> 当中</p>

<pre><code>local tmpl = {
  &quot;default_shift_between_bar&quot;: 1.3,
  &quot;title_panel_size_x&quot;: 2,
  &quot;title_panel_size_y&quot;: 1,
  &quot;title_panel_scale&quot;: 0.9,
  &quot;title_panel_distance_to_data_bar&quot;: -1.2,
  &quot;title_panel_distance_to_camera&quot;: 0.4,
  &quot;num_panel_exist&quot;: true,
  &quot;num_panel_cfg&quot;: {
    &quot;blah&quot;: &quot;blah&quot;,
  },
  &quot;animation_config&quot;: {
    &quot;blah&quot;: &quot;blah&quot;,,
  }
};

tmpl + std.extVar('config') + {data_bar_count:std.extVar('data_bar_count')} 
</code></pre>

<p>这样我们在真正执行构建 <code>stag4</code> 这个视频片段就可以使用 <code>config_gen_stag4</code> 渲染好的 <code>json</code> 来执行 <code>3d</code> 建模生产 <code>blender project</code>。</p>

<p>其中 Jsonnet 语法可以参考关于 <a href="https://jsonnet.org/learning/tutorial.html#oo">OOP</a> 的语法解释。</p>

<h2>配置硬编码问题</h2>

<p>当你解决了配置生成问题之后会遇到配置硬编码的问题这里没什么好分享的可以直接<a href="https://docs.bazel.build/versions/master/skylark/config.html">参考文档</a>。</p>

<p>具体使用中可以参考 <a href="https://docs.bazel.build/versions/master/guide.html#bazelrc-the-bazel-configuration-file"><code>.bazelrc</code></a> 的说明。</p>

<p>从上面的参考文档我们可以知道 <code>flag</code> 的名字是可以使用 bazel label 作为名字的因此我们的 bazelrc 还是一种代码生成很友好的解决方案。</p>

<h2>最后</h2>

<p>我经过了上面的学习和实践同时我也学习到了 <a href="https://github.com/google/starlark-go/">starlark-go</a> 和 <a href="https://github.com/google/go-jsonnet">go-jsonnet</a> 结合在一起会是一个非常好的组合， 无论是在配置，编排，还是自动化领域都是一个不错工具。 在未来的产品开发和构建当中我应该会使用这种组合来提升我的人效。</p>

</div>

<hr>
本人博客文章采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC Attribution-NonCommercial协议</a>: CC Attribution-NonCommercial 必须保留原作者署名,并且不允许用于商业用途,其他行为都是允许的。
<hr>

<script src="https://utteranc.es/client.js"
        repo="lijianying10/RollingBlog"
        issue-term="bazel macro 的开发"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<!-- Blog Post -->

<!-- Title -->
<h1><a href="/2021/01/15/bazelboost/">bazel 使用经验和记录</a></h1>
 
<!-- Author -->
<p class="lead">
Tags

<a href="/tags/bazel">bazel</a>

</p>

<hr>

<!-- Date/Time -->
<p><span class="glyphicon glyphicon-time"></span> 2021-01-15 19:01:18</p>

<hr>

<div class="typo">
<p>近期我自己做的项目已经用上 Bazel 这款产品了。 它是我目前学过的最难学的一门技术（工具）了。 下面总结一下我的学习和使用过程和方法。
一方面我想提升自己的总结能力，另外一方面我自己学习的时候很寂寞身边没有人会这门技术，大多都是用一用编译就好了， 并不想深入了解。</p>

<h2>我为什么要用bazel</h2>

<p>我最近在做3d建模视频我的主要业务逻辑使用的go语言，blender只能使用python语言，不少操作的驱动需要使用python实现。
不少SVG从矢量到标量的计算用到了NodeJS，并且我的项目并不能统一语言去做。</p>

<p>依赖复杂，我有很多种action而且未来还会有更多。例如目前我有的操作：</p>

<ol>
<li>SVG矢量转标量</li>
<li>依赖上面的结果让两个svg path 正交 绘制 mesh 并且输出 Wavefront OBJ 3d 模型的格式 （未来还会有更多的 Mesh 建模算法来应对各种不同的建模场景）</li>
<li>运行blender background 模式调用我写的 python library 和 python RPC server 对接 golang 建模用业务层。</li>
<li>blender建模和动画的结果之间可以相互引用和复用。</li>
</ol>

<p>所以这是一个相当复杂的 Dag （有向无环图） 因此每当我动一个比较底层的算法我需要 快速的 正确的 构建并且执行Dag依赖树。</p>

<p>当我编译好我的blender工程之后我就可以把blender文件上传到GPU集群来渲染视频。</p>

<p>一个更简单的为什么要使用bazel的例子：</p>

<p>当你自己写了一个 golang 程序帮助你输入一个 SQL 语句输出一个对应的驱动包来避免使用 ORM 当你修改了 code gen 的模板时你怎么知道该更新那些和测试那些依赖于它的目标 ( Target ) 呢?</p>

<p>并且你并不想写一大堆重复的类似的代码 干体力活 希望机器生成代码， 并且你知道 Golang 没有泛型造成很多重复代码时， 我们唯一的选择就只能是设计一个Code Generator。</p>

<h2>学习路线</h2>

<p>这里记录一下我的学习路线方便当我自己忘记知识点可以看这篇文字帮助自己复习， 我的学习目标并不是 使用 bazel  而是熟练的掌握开发 rules 应对各类情况。</p>

<h3>Concepts 了解基本概念全部读完。</h3>

<p>举个例子：</p>

<pre><code>Transitive dependencies
Bazel only reads dependencies listed in your WORKSPACE file. If your project (A) depends on another project (B) which lists a dependency on a third project (C) in its WORKSPACE file, youll have to add both B and C to your projects WORKSPACE file. This requirement can balloon the WORKSPACE file size, but limits the chances of having one library include C at version 1.0 and another include C at 2.0.
</code></pre>

<p>当你的 Workspace 越来越大时如果你能想起这里来。 你会发现并不是忘记读了什么文档使用什么方法而是就这样设计的。</p>

<p>Concepts 里面有非常多设计者的意图，是一个系统设计非常好的学习资料。</p>

<h3>Extending Bazel 中的 Extension Overview 和 Concepts</h3>

<p>Extending Bazel 其实就是写rules来处理自己的工作情况。
这里一定都要读完，意义很大比如一个重要的概念 Depsets 你读完文档之后并不知道它是 immutable variable。
如果你并不理解文档的情况下就会一脸懵逼的碰到 rules 的设计问题，很多变量是只读的文档里面没有提到但是你要反应过来。
所以前期文档阅读量不足会耽误很多时间。因为遇到问题你反应不过来。</p>

<h3>换个角度继续学</h3>

<p>当我看完上面的文档时还不知道怎么下手， 云里雾里， 这时候有一个重要的 blog 出现：
<a href="https://www.jayconrod.com/posts/106/writing-bazel-rules--simple-binary-rule">https://www.jayconrod.com/posts/106/writing-bazel-rules--simple-binary-rule</a></p>

<p>这些文章需要拿出来反复琢磨：</p>

<ol>
<li>Writing Bazel rules: simple binary rule 帮助你学习如何构建好一个target</li>
<li>Writing Bazel rules: library rule, depsets, providers 帮助你学习如何处理好依赖，很重要，因为你知道bazel的核心依赖算法是DAG</li>
<li>Writing Bazel rules: repository rules 帮助你把外部的软件转换成一个 bazel 系统可以接受的依赖很重要，比如说你构建时依赖了 blender 的二进制文件去运行， 它就会帮助你做到类似于 <code>rules_go</code> 一样下载 golang 的 toolchain</li>
</ol>

<p>以上是写的非常好的非官方的tutorial。</p>

<p>我看到这时还是不会写。接下来开始读源码推荐阅读：</p>

<ol>
<li>一个复杂的： <a href="https://github.com/bazelbuild/rules_go">GITHUB REPO</a> 去看首页文档写的重要API的实现。</li>
<li>一个简单的： <a href="https://github.com/zaucy/rules_blender">GITHUB REPO</a> 去看比较简单的case的关键rules实现。</li>
</ol>

<p>当我看到这里时我基本上已经写了个大概。因为已经大概熟悉了 Skylark 这门语言。进入爬坑阶段。</p>

<h3>最重要的我常常需要参考的关键数据结构</h3>

<p>Actions <a href="https://docs.bazel.build/versions/master/skylark/lib/actions.html">https://docs.bazel.build/versions/master/skylark/lib/actions.html</a> 这是核心中的核心
Files <a href="https://docs.bazel.build/versions/master/skylark/lib/File.html">https://docs.bazel.build/versions/master/skylark/lib/File.html</a> 写 rules 其实就是灵活的处理你的代码文件与编译器之间做沟通。
DefaultInfo <a href="https://docs.bazel.build/versions/master/skylark/lib/DefaultInfo.html">https://docs.bazel.build/versions/master/skylark/lib/DefaultInfo.html</a> 理解好这个概念可以帮助你与其他开发者写的 Rules 很好的做对接和依赖。</p>

<h2>爬坑经验</h2>

<h3>代理方案选择</h3>

<ol>
<li>linux iptables ip filter 省事</li>
<li>windows Proxifier</li>
</ol>

<p>windows 注意：</p>

<p>因为 Proxifier 是按照进程为最基本单位的， 当你看不到具体那个进程网络卡住了可以使用工具，可以看到进程树：</p>

<p>process monitor： <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">https://docs.microsoft.com/en-us/sysinternals/downloads/procmon</a></p>

<p>目前我的进程rules: <code>bazel.exe;java.exe;fetch_repo.exe;Conhost.exe;go.exe;git.exe;git-remote-https.exe;</code> 供参考</p>

<h3>管理你系统外的依赖</h3>

<p>系统外依赖的定义是： 你并不关心实现的代码。仅仅是下载， 比如说 GJSON 这类的</p>

<p>Cons:</p>

<p>你在A项目中引用了B项目 B项目引用了GJSON 那么A的workspace 也需要管理 GJSON 依赖。 这时你的 WORKSPACE 文件会像气球一样膨胀
我遇到这个坑是因为我对 Concept 文档理解的不够深入。</p>

<p>Pros:</p>

<p>可以实现 Shadowing dependencies 在文档： <a href="https://docs.bazel.build/versions/master/external.html">https://docs.bazel.build/versions/master/external.html</a> 提到的</p>

<h3>关于 actions run 这个函数的坑</h3>

<p>这些坑都是希望假如我身边有人会这技术我希望他能提前告诉我的</p>

<ol>
<li><code>declare_file</code> 一定要放到output里面。 这样当你的 actions.run 结束时文件没创建， 会显示编译错误。</li>
<li><code>inputs</code> 一定要把你依赖的所有文件都放到这个数组里面。 就算 bazel query 时的确显示出了正确的依赖关系， 但是 inputs 没有声明这些文件在actions中依赖了你会你修改了文件不会重新编译。 会破坏编译的正确性。</li>
<li><code>mnemonic</code> 只能是一个单词，放入要给动词可以帮助你理解正在并行编译时在做什么动作。</li>
<li><code>executable</code> 不要依赖与你的path或者一个绝对路径那就出现了环境依赖，要使用 target 来保证整个系统时封闭的来保证你的 <code>正确性</code></li>
<li><code>use_default_shell_env</code> <code>False</code> = 有节操 <code>True</code> = 没节操 如果你选择省事至少放到Docker容器里面定义好Path运行。不然会出现环境依赖以及脱离 bazel 环境管理的软件依赖。</li>
<li><code>tools</code> 假如你在构建中依赖了其他的二进制文件， 例如我在运行 blender 我的入口时 python 的 RPC Server， 我用 Golang 写 RPC client 你很熟练的通过 arguments 或者 env 把你的 Golang client 二进制文件放到了 执行的地方，但是你会新奇的发现 bazel 系统的构建 DAG 树的 Graphviz 图纸是有依赖的但是它并不构建， 然而你读了很多遍文档也不知道为什么你依赖的二进制 bazel target 不编译因为文档的描述是这样的： <code>tools: List or depset of any tools needed by the action. Tools are inputs with additional runfiles that are automatically made available to the action.</code> 现在我可以高兴的告诉你这时候要放到tools里面。出现这个问题并不是文档有问题，是 bazel 的设计者经验丰富抽象层次高造成的。但是我给跪了。</li>
</ol>

<h4>input 数组的开发技巧</h4>

<p>例如说你依赖了 <code>py_library</code> 这个 bazel native rule</p>

<p>第一你需要debug看这个rules返回给你什么info</p>

<p>下面时rules label attr</p>

<pre><code>&quot;util&quot;:attr.label(),
</code></pre>

<p>输入参数label例子： 下面这个例子的util其实就是一个 <code>py_library rule</code></p>

<pre><code>util = &quot;//blenderutil:util&quot;,
</code></pre>

<p>下面时skylark 调试代码, 可以看到有什么Info</p>

<pre><code>print(ctx.attr.util)
</code></pre>

<p>一点点的调试最后可以得到下面的代码：</p>

<pre><code>for f in ctx.attr.util[PyInfo].transitive_sources.to_list():
    input_list.append(f)
</code></pre>

<p>你会得到你所有依赖的内容如果你的依赖很复杂 比如说  <code>A-&gt;B-&gt;C</code>  <code>A-&gt;D-&gt;C</code> 你会发现C重复了。可以直接用depset解决这个问题 <code>new_var = depset([这里时你的数组，或者直接把变量放进去])</code></p>

<h4>executable 的例子</h4>

<p>定义label</p>

<pre><code>&quot;_blenderRunner&quot;:attr.label(
    default = Label(&quot;//blenderRunner:blenderRunner&quot;),
    executable = True,
    cfg = &quot;exec&quot;
),
</code></pre>

<p>action.run 参数例子</p>

<pre><code>executable = ctx.executable._blenderRunner, 
</code></pre>

<h2>一些感悟</h2>

<h3>为什么 golang 要用 bazel</h3>

<p>目前 gomod 已经做的够好了，就算在我的这个工程里面也会使用 golang gomod 来开发和测试我的代码。
但是与 bazel 结合其实成本并不高有重要的工具叫 <code>gazelle</code>
他可以帮助你转换 gomod 项目成 bazel 项目。
也可以帮助你同步 gomod 到 bazel。</p>

<p>通过如下命令：</p>

<pre><code>bazel run //:gazelle # 初始化 
bazel run //:gazelle -- update-repos -from_file=go.mod -to_macro=deps.bzl%go_dependencies # 更新
</code></pre>

<p>需要注意：</p>

<ol>
<li>你还是要显式从 WORKSPACE 或者你自己的 bazel function 中声明你的 <code>go_repository</code> rule 来定义依赖。</li>
<li>关于 golang bazel 项目吐槽最多的 protobuf 生成之后 IDE 很难结合的问题可以结合这个思路 <a href="https://github.com/nikunjy/golink">https://github.com/nikunjy/golink</a> 另外我在自己读 bazel rule 开发文档的时候看到其实我们是可以通过创建软连接来帮助IDE找到我们已经生成的代码。</li>
<li>上面的问题还有另外一个解决思路， 修改 Gocode 的实现，目前 Gocode 这个项目已经有 daemon 了。 但是它扫描代码并不积极。</li>
</ol>

<h3>一个恰到好处的设计</h3>

<p>从actions.run这里可以看到，
每个参数设计的都很到位， 尤其是限制的很到位， 并且每个每个参数都不能删掉， 并且很好的兼顾了各种情况。
新手只可能对概念的理解和知识的掌握不到位， 很难产生一些错误， 这大概就是牛逼的架构师设计的接口。
把安全做到语言级别， 给你报错而不是你在写代码的时候给你各种需要主动遵守的规范。</p>

<p>如果你并不享受这些对你的限制，还不如用 python 或者 make 之类作为构建工具。</p>

<h3>一些 bazel 相比其他构建系统的好处</h3>

<ol>
<li>封装的好，会让构建过程产出结果稳定，受环境的影响可以做到尽量小，也可以让依赖多个版本并存</li>
<li>Starlark 语言设计的好， 类似 python 写起来贼舒服被裁剪的很好， 一方面是影响话编译环境的API都被裁掉了（你并不能很容易的写文件到磁盘到任意位置）内部帮助你构建的变量都是只读的。当然它的好是相对于 GnuMake 和 CMake 相比。</li>
<li>因为拓展性好，基本上你能想到的语言都有了现成的Rules支持。</li>
<li>对 Code Generation 非常友好。</li>
<li><code>正确</code> <code>快速</code> 实至名归</li>
</ol>

<h2>最后</h2>

<p>很开心我看到了 Bazel 的门， 希望我能早日入门。</p>

</div>

<hr>
本人博客文章采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC Attribution-NonCommercial协议</a>: CC Attribution-NonCommercial 必须保留原作者署名,并且不允许用于商业用途,其他行为都是允许的。
<hr>

<script src="https://utteranc.es/client.js"
        repo="lijianying10/RollingBlog"
        issue-term="bazel 使用经验和记录"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<!-- Blog Post -->

<!-- Title -->
<h1><a href="/2021/01/14/dockerprivateregistry/">小型团队内网创建docker registry</a></h1>
 
<!-- Author -->
<p class="lead">
Tags

<a href="/tags/docker">docker</a>

<a href="/tags/registry">registry</a>

<a href="/tags/ssl">ssl</a>

<a href="/tags/nginx">nginx</a>

</p>

<hr>

<!-- Date/Time -->
<p><span class="glyphicon glyphicon-time"></span> 2021-01-14 12:07:26</p>

<hr>

<div class="typo">
<p>docker registry 是作为容器相关自动化关键底层基础设施，作为一种重要的artifact存储形式，对接CI/CD Kubernetes 都非常方便。</p>

<p>结构设计：</p>

<pre><code>
                                       ---&gt; registry (run in docker container)
http traffic -&gt; host nginx with ssl ---|
                                       ---&gt; registry UI (run in docker container)


</code></pre>

<h2>部署过程</h2>

<h3>1. 部署docker容器</h3>

<pre><code>docker run -d -p 5000:5000 --restart=always --name registry -v /data/registry:/var/lib/registry registry:2
docker run -d -p 5001:80 --name registry-ui -e DELETE_IMAGES=true joxit/docker-registry-ui:static
</code></pre>

<p>注意：</p>

<ol>
<li>regisry 存储放到了 host 的 <code>/data/registry</code> 位置需要可以修改</li>
<li>ui 允许删除数据，更多选项参考：<a href="https://hub.docker.com/r/joxit/docker-registry-ui">这里</a> 的Run the static interface 段落</li>
<li>我快速的读了一下这个 registry-ui 的代码其实它是个静态网页项目，dockerfile 的内容显示其实里面就是个nginx 所以说明书上面的 <code>跨域</code> 和 <code>registry_url</code> 和 <code>SSL</code> 相关配置可以直接如下的 Nginx reverse proxy配置中直接干净快速的解决。</li>
</ol>

<h3>2. 部署Nginx</h3>

<pre><code>$ cat /etc/nginx/sites-enabled/registry
server {
        listen 443 ssl;
        server_name hub.philo.top;
        ssl_certificate     /etc/ssl/1_hub.philo.top_bundle.crt;
        ssl_certificate_key /etc/ssl/2_hub.philo.top.key;
        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers         HIGH:!aNULL:!MD5;
        client_max_body_size 2048M;
        location / {
                proxy_pass http://127.0.0.1:5001;
        }
        location /v2 {
                proxy_pass http://127.0.0.1:5000;
        }
}

server{
        listen 80;
        server_name hub.philo.top;
        return 301 https://$host$request_uri;
}
</code></pre>

<p>注意：</p>

<ol>
<li>第一行是命令是提示文件存放位置</li>
<li>安装nginx的方法是 <code>apt-get update &amp;&amp; apt-get install -y nginx</code></li>
<li><code>server_name</code> 命令需要改成你自己的域名</li>
<li>证书淘宝买 5 块钱 店铺名字 <code>鼎森网络科技有限公司</code> 因为是内网使用的证书所以用Let&rsquo;s encrypt比较麻烦。</li>
<li>命令 <code>client_max_body_size</code> 不要裁剪，因为docker pull 和 push 的 http body 很大。</li>
<li><code>location /</code> 的作用是路由到 ui container</li>
<li><code>location /v2</code> 的作用是路由到 docker registry</li>
<li>别忘了设置域名A记录</li>
<li><code>SSL</code> 证书最好是要配置上的，原因是docker pull过程默认是要证书的不然需要特别配置trust同理 kubernetes 也有类似的需求稍微衡量一下5块钱还是值得的</li>
<li>下面的一个Server是为了强制HTTPS</li>
</ol>

</div>

<hr>
本人博客文章采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC Attribution-NonCommercial协议</a>: CC Attribution-NonCommercial 必须保留原作者署名,并且不允许用于商业用途,其他行为都是允许的。
<hr>

<script src="https://utteranc.es/client.js"
        repo="lijianying10/RollingBlog"
        issue-term="小型团队内网创建docker registry"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<!-- Blog Post -->

<!-- Title -->
<h1><a href="/2021/01/14/ubuntudnssystemdresolved/">网关服务器部署DNS的冲突问题解决</a></h1>
 
<!-- Author -->
<p class="lead">
Tags

<a href="/tags/ubuntu">ubuntu</a>

<a href="/tags/dns">dns</a>

<a href="/tags/systemd-resolved">systemd-resolved</a>

</p>

<hr>

<!-- Date/Time -->
<p><span class="glyphicon glyphicon-time"></span> 2021-01-14 10:40:11</p>

<hr>

<div class="typo">
<p>因为5.4内核对网络的管理修改很多，在自己部署DNS服务器时，发现systemd-resolved.service占用端口53</p>

<p>所以这里Ubuntu 20.04 的运维SOP如下:</p>

<ol>
<li>netplan 设置nameserver 127.0.0.1 apply</li>
<li>systemd-resolved.service stop &amp;&amp; disable</li>
<li>部署你自己的dns server</li>
<li>delete softlink /etc/resolv.conf 写入 <code>nameserver 127.0.0.1</code></li>
</ol>

<p>注意，Docker daemon会默认指定 8.8.8.8 8.8.4.4 作为dns 不会再取系统配置 (Docker 20.10.1 行为)
所以如果做了特别的DNS配置需要对Daemon配置方法参考这里 <a href="https://forums.docker.com/t/local-dns-or-public-dns-why-not-both-etc-docker-daemon-json/54544">https://forums.docker.com/t/local-dns-or-public-dns-why-not-both-etc-docker-daemon-json/54544</a></p>

</div>

<hr>
本人博客文章采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC Attribution-NonCommercial协议</a>: CC Attribution-NonCommercial 必须保留原作者署名,并且不允许用于商业用途,其他行为都是允许的。
<hr>

<script src="https://utteranc.es/client.js"
        repo="lijianying10/RollingBlog"
        issue-term="网关服务器部署DNS的冲突问题解决"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<!-- Blog Post -->

<!-- Title -->
<h1><a href="/2021/01/13/iptablesredsocksdocker/">iptables 使用 Redsocks 时候 Docker 没有网络问题的分析</a></h1>
 
<!-- Author -->
<p class="lead">
Tags

<a href="/tags/iptables">iptables</a>

<a href="/tags/docker">docker</a>

<a href="/tags/redsocks">redsocks</a>

<a href="/tags/network">network</a>

</p>

<hr>

<!-- Date/Time -->
<p><span class="glyphicon glyphicon-time"></span> 2021-01-13 20:33:10</p>

<hr>

<div class="typo">
<p>今天我自己遇到了一个故障，Docker里面没有网络。</p>

<p>最开始以为是我iptables设置有错误。通过仔细阅读文档发现估计并不是iptables的配置有问题。</p>

<p>后来发现一个特征，凡是走Redsocks RETURN target 全都可以联通，发现这个主要是我无意间发现内网是通的。</p>

<p>所以定位核心故障是Redsocks不通的，这时候发现Redsocks的Listen address 是有问题的.
因为Docker是通过网桥来到local的所以IP地址不是本地所以redsocks需要监听0.0.0.0</p>

<h2>所以正确的配置如下</h2>

<h3>chnroute 生成中国的ip地址</h3>

<pre><code>curl 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | grep ipv4 | grep CN | awk -F\| '{ printf(&quot;%s/%d\n&quot;, $4, 32-log($5)/log(2)) }    ' &gt; chnroute.txt
</code></pre>

<p>我们默认绕过中国的ip地址</p>

<h3>redsocks 配置文件</h3>

<pre><code>base {
        // debug: connection progress &amp; client list on SIGUSR1
        log_debug = off;

        // info: start and end of client session
        log_info = on;

        /* possible `log' values are:
         *   stderr
         *   &quot;file:/path/to/file&quot;
         *   syslog:FACILITY  facility is any of &quot;daemon&quot;, &quot;local0&quot;...&quot;local7&quot;
         */
        log = &quot;syslog:daemon&quot;;

        // detach from console
        daemon = on;

        /* Change uid, gid and root directory, these options require root
         * privilegies on startup.
         * Note, your chroot may requre /etc/localtime if you write log to syslog.
         * Log is opened before chroot &amp; uid changing.
         */
        user = redsocks;
        group = redsocks;
        // chroot = &quot;/var/chroot&quot;;

        /* possible `redirector' values are:
         *   iptables   - for Linux
         *   ipf        - for FreeBSD
         *   pf         - for OpenBSD
         *   generic    - some generic redirector that MAY work
         */
        redirector = iptables;
}

redsocks {
        /* `local_ip' defaults to 127.0.0.1 for security reasons,
         * use 0.0.0.0 if you want to listen on every interface.
         * `local_*' are used as port to redirect to.
         */
        local_ip = 0.0.0.0;
        local_port = 12345;

        // `ip' and `port' are IP and tcp-port of proxy-server
        // You can also use hostname instead of IP, only one (random)
        // address of multihomed host will be used.
        ip = 1.2.3.4;
        port = 8089;


        // known types: socks4, socks5, http-connect, http-relay
        type = socks5;

        // login = &quot;foobar&quot;;
        // password = &quot;baz&quot;;
}
</code></pre>

<h3>iptables 配置</h3>

<pre><code>set -x
set -e

# 下面两句是添加中国的ip表
sudo ipset create chnroute hash:net
cat chnroute.txt | sudo xargs -I ip ipset add chnroute ip

# 在 nat 表中创建新链
iptables -t nat -N REDSOCKS
## 首先这个代理要屏蔽网络代理出口服务（直接return嘛）

# 下面是添加例外端口的例子
#iptables -t nat -A REDSOCKS -p tcp --dport 59237 -j RETURN
# 下面是添加例外ip地址的例子
#iptables -t nat -A REDSOCKS -d 45.76.241.57 -j RETURN
#iptables -t nat -A REDSOCKS -d 45.32.79.211 -j RETURN
#iptables -t nat -A REDSOCKS -d 144.202.84.244 -j RETURN

# 过滤Docker container 网段 （默认的）
iptables -t nat -A REDSOCKS -d 172.17.0.0/16 -j RETURN
# 过滤局域网段
iptables -t nat -A REDSOCKS -d 10.0.0.0/8 -j RETURN
iptables -t nat -A REDSOCKS -d 127.0.0.0/8 -j RETURN
iptables -t nat -A REDSOCKS -d 169.254.0.0/16 -j RETURN
iptables -t nat -A REDSOCKS -d 172.16.0.0/12 -j RETURN
iptables -t nat -A REDSOCKS -d 192.168.0.0/16 -j RETURN
iptables -t nat -A REDSOCKS -d 224.0.0.0/4 -j RETURN
iptables -t nat -A REDSOCKS -d 240.0.0.0/4 -j RETURN
# enable 中国的ipset
iptables -t nat -A REDSOCKS -p tcp -m set --match-set chnroute dst -j RETURN
# FWD 需要走代理的情况，直接打到redsock的tcp port
iptables -t nat -A REDSOCKS -p tcp -j REDIRECT --to-ports 12345

# 让上面这个过滤用途的Chain 在PREROUTING中使用（本Linux系统作为 Gateway时候使用）
iptables -t nat -I PREROUTING -p tcp -j REDSOCKS
# 为本机的代理append chain
iptables -t nat -I OUTPUT -p tcp -j REDSOCKS
# 使用docker的时候FWD的DROP的据说是为了安全，但是这里，得给FWD了。不然转发机器无法上网
iptables -P FORWARD ACCEPT
</code></pre>

<h2>注意事项</h2>

<ol>
<li>如果你要用本机作为gateway别忘了做这个操作： <a href="https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux">https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux</a></li>
<li>Redsocks 的 upstream socks5 要改成你自己的</li>
</ol>

</div>

<hr>
本人博客文章采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC Attribution-NonCommercial协议</a>: CC Attribution-NonCommercial 必须保留原作者署名,并且不允许用于商业用途,其他行为都是允许的。
<hr>

<script src="https://utteranc.es/client.js"
        repo="lijianying10/RollingBlog"
        issue-term="iptables 使用 Redsocks 时候 Docker 没有网络问题的分析"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                </div>

                <!-- Blog Sidebar Widgets Column -->
                <div class="col-lg-3 col-12">

                    <!-- Blog Search Well -->
                    <!--                 <div class="well">
                        <h4>Blog Search</h4>
                        <div class="input-group">
                        <input type="text" class="form-control">
                        <span class="input-group-btn">
                        <button class="btn btn-default" type="button">
                        <span class="glyphicon glyphicon-search"></span>
                        </button>
                        </span>
                        </div> -->
                        <!-- /.input-group -->
                        <!-- </div> -->

                        <!-- Blog Categories Well -->
                        <div class="well">
                            <h4>TAGS</h4>
                            <div class="row">
                                <div class="col-lg-6">
                                    <ul class="list-unstyled">
                                        <!--                                 <li><a href="#">Category Name</a>
                                            </li>
                                            <li><a href="#">Category Name</a>
                                            </li>
                                            <li><a href="#">Category Name</a>
                                            </li>
                                            <li><a href="#">Category Name</a>
                                            </li> -->
                                            <a href="/tags/wiki">wiki(2)</a></br><a href="/tags/thinking">thinking(3)</a></br><a href="/tags/node">node(1)</a></br><a href="/tags/iptables">iptables(1)</a></br><a href="/tags/devenv">devenv(1)</a></br><a href="/tags/elk">elk(1)</a></br><a href="/tags/oop">oop(1)</a></br><a href="/tags/html">html(1)</a></br><a href="/tags/mesos">mesos(1)</a></br><a href="/tags/tmux">tmux(1)</a></br><a href="/tags/git">git(8)</a></br><a href="/tags/nodejs">nodejs(1)</a></br><a href="/tags/DaoCloud">DaoCloud(1)</a></br><a href="/tags/java">java(2)</a></br><a href="/tags/visualization">visualization(1)</a></br><a href="/tags/elasticsearch">elasticsearch(1)</a></br><a href="/tags/requirejs">requirejs(1)</a></br><a href="/tags/network">network(2)</a></br><a href="/tags/dns">dns(1)</a></br><a href="/tags/ss">ss(1)</a></br><a href="/tags/css">css(1)</a></br><a href="/tags/docker">docker(22)</a></br><a href="/tags/centos">centos(1)</a></br><a href="/tags/mysql">mysql(3)</a></br><a href="/tags/grub">grub(1)</a></br><a href="/tags/butterfly">butterfly(1)</a></br><a href="/tags/web">web(3)</a></br><a href="/tags/php">php(1)</a></br><a href="/tags/mongodab">mongodab(1)</a></br><a href="/tags/putty">putty(2)</a></br><a href="/tags/RHEL">RHEL(1)</a></br><a href="/tags/PXE">PXE(1)</a></br><a href="/tags/ci">ci(1)</a></br><a href="/tags/iPXE">iPXE(1)</a></br><a href="/tags/gh60">gh60(1)</a></br><a href="/tags/env">env(2)</a></br><a href="/tags/DES">DES(1)</a></br><a href="/tags/microservice">microservice(2)</a></br><a href="/tags/Ubuntu">Ubuntu(1)</a></br><a href="/tags/logstash">logstash(1)</a></br><a href="/tags/c">c(1)</a></br><a href="/tags/marathon">marathon(1)</a></br><a href="/tags/owncloud">owncloud(1)</a></br><a href="/tags/npm">npm(1)</a></br><a href="/tags/virtualbox">virtualbox(3)</a></br><a href="/tags/python">python(4)</a></br><a href="/tags/delegate">delegate(1)</a></br><a href="/tags/mac">mac(2)</a></br><a href="/tags/tray">tray(1)</a></br><a href="/tags/require.js">require.js(1)</a></br><a href="/tags/etcd">etcd(3)</a></br><a href="/tags/postgresql">postgresql(1)</a></br><a href="/tags/systemd-resolved">systemd-resolved(1)</a></br><a href="/tags/js">js(8)</a></br><a href="/tags/phpExtension">phpExtension(1)</a></br><a href="/tags/rancher">rancher(2)</a></br><a href="/tags/html5">html5(1)</a></br><a href="/tags/test">test(1)</a></br>
                                    </ul>
                                </div>
                                <div class="col-lg-6">
                                    <ul class="list-unstyled">
                                        <!--                                 <li><a href="#">Category Name</a>
                                            </li>
                                            <li><a href="#">Category Name</a>
                                            </li>
                                            <li><a href="#">Category Name</a>
                                            </li>
                                            <li><a href="#">Category Name</a>
                                            </li> -->
                                            <a href="/tags/homebrew">homebrew(1)</a></br><a href="/tags/linux">linux(5)</a></br><a href="/tags/macos">macos(1)</a></br><a href="/tags/Cow">Cow(1)</a></br><a href="/tags/yaml">yaml(1)</a></br><a href="/tags/golang">golang(23)</a></br><a href="/tags/ucloud">ucloud(1)</a></br><a href="/tags/redsocks">redsocks(1)</a></br><a href="/tags/article">article(1)</a></br><a href="/tags/Docker">Docker(2)</a></br><a href="/tags/minecraft">minecraft(2)</a></br><a href="/tags/vim">vim(3)</a></br><a href="/tags/storage">storage(1)</a></br><a href="/tags/atom">atom(2)</a></br><a href="/tags/MongoDB">MongoDB(1)</a></br><a href="/tags/runc">runc(1)</a></br><a href="/tags/bootstrap">bootstrap(1)</a></br><a href="/tags/HomeBrew">HomeBrew(1)</a></br><a href="/tags/iterm2">iterm2(1)</a></br><a href="/tags/flannel">flannel(1)</a></br><a href="/tags/RunC">RunC(1)</a></br><a href="/tags/bazel">bazel(2)</a></br><a href="/tags/dev">dev(2)</a></br><a href="/tags/profiling">profiling(2)</a></br><a href="/tags/kibina">kibina(1)</a></br><a href="/tags/android">android(1)</a></br><a href="/tags/hexo">hexo(3)</a></br><a href="/tags/nginx">nginx(6)</a></br><a href="/tags/ubuntu">ubuntu(5)</a></br><a href="/tags/career">career(1)</a></br><a href="/tags/syslinux">syslinux(1)</a></br><a href="/tags/aglio">aglio(1)</a></br><a href="/tags/blog">blog(1)</a></br><a href="/tags/liteIDE">liteIDE(1)</a></br><a href="/tags/metaprogramming">metaprogramming(1)</a></br><a href="/tags/BusyBox">BusyBox(1)</a></br><a href="/tags/杂谈">杂谈(1)</a></br><a href="/tags/thrift">thrift(1)</a></br><a href="/tags/rkt">rkt(1)</a></br><a href="/tags/ssl">ssl(2)</a></br><a href="/tags/letsencrypt">letsencrypt(1)</a></br><a href="/tags/consul">consul(1)</a></br><a href="/tags/mongodb">mongodb(3)</a></br><a href="/tags/busybox">busybox(1)</a></br><a href="/tags/coreos">coreos(1)</a></br><a href="/tags/GC">GC(1)</a></br><a href="/tags/Linux">Linux(13)</a></br><a href="/tags/ShadowSocks">ShadowSocks(1)</a></br><a href="/tags/registry">registry(3)</a></br><a href="/tags/CoreOS">CoreOS(1)</a></br><a href="/tags/netplan">netplan(1)</a></br><a href="/tags/godoc">godoc(1)</a></br><a href="/tags/osx">osx(4)</a></br><a href="/tags/datatables">datatables(1)</a></br><a href="/tags/StackStorm2">StackStorm2(1)</a></br><a href="/tags/tenxcloud">tenxcloud(1)</a></br><a href="/tags/shell">shell(6)</a></br>
                                    </ul>
                                </div>
                            </div>
                            <!-- /.row -->
                        </div>

                        <!-- Side Widget Well -->
                        <div class="well">
                            <h4>近期文章</h4>
                            <a href="/2021/03/14/metaprogramming/">Metaprogramming and code generation/replace in action</a></br><a href="/2021/02/15/dockerprivateregistryen/">deploy docker registry under private network</a></br><a href="/2021/02/14/golangvimdev/">my vim golang programming environment</a></br><a href="/2021/02/06/bazelmacro/">bazel macro 的开发</a></br><a href="/2021/01/15/bazelboost/">bazel 使用经验和记录</a></br><a href="/2021/01/14/dockerprivateregistry/">小型团队内网创建docker registry</a></br><a href="/2021/01/14/ubuntudnssystemdresolved/">网关服务器部署DNS的冲突问题解决</a></br><a href="/2021/01/13/iptablesredsocksdocker/">iptables 使用 Redsocks 时候 Docker 没有网络问题的分析</a></br>
                        </div>
                        <div class="well">
                            <h4>友情链接</h4>
                            <a href="https://linux.cn/">Linux中国</a></br>
                            <a href="http://locez.com/">LOCEZ</a></br>
                            <a href="http://blog.ibeats.top/">CI_Knight</a>
                        </div>

                </div>

            </div>
            <!-- /.row -->

            <hr>

            <!-- Footer -->
            <footer>
                <div class="row">
                    <div class="col-lg-12">
                        <p>Copyright &copy; philo.top PowerBy <a href="https://github.com/lijianying10/RollingBlog">RollingBlog</a> 2020 Since 2015</p>
                        <!-- Global site tag (gtag.js) - Google Analytics -->
                        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-173403528-1"></script>
                        <script>
                          window.dataLayer = window.dataLayer || [];
                          function gtag(){dataLayer.push(arguments);}
                          gtag('js', new Date());
                        
                          gtag('config', 'UA-173403528-1');
                        </script>

                    </div>
                </div>
                <!-- /.row -->
            </footer>

        </div>
        <!-- /.container -->

        <!-- jQuery -->
        <script src="/js/jquery.js"></script>

        <!-- Bootstrap Core JavaScript -->
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/prism.js"></script>

    </body>

</html>

